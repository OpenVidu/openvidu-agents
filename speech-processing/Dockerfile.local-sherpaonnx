# syntax=docker/dockerfile:1.6
# Dockerfile for sherpa streaming STT
# Self-contained image with sherpa models for offline streaming speech recognition
# No external API calls required - all processing happens locally
#
# BUILD INSTRUCTIONS (LOCAL DEVELOPMENT):
# This Dockerfile installs the plugin from a local directory for testing.
#
# 1. First, copy the plugin to the build context:
#    cp -r /home/pablo/Desktop/VOSK/agents/livekit-plugins/livekit-plugins-sherpa ./livekit-plugins-sherpa
#
# 2. Build the image:
#    docker build -f Dockerfile.sherpa -t openvidu/agent-speech-processing-sherpa:main .
#
# Note: For production, switch back to installing from GitHub repository.

ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Builder - Install dependencies
# =============================================================================
FROM ${BASE_IMAGE} AS builder

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy base requirements and install them first
COPY requirements-base.txt ./
RUN pip install --no-cache-dir -r requirements-base.txt

# Copy the local plugin directory and install it
COPY livekit-plugins-sherpa ./livekit-plugins-sherpa
RUN pip install --no-cache-dir ./livekit-plugins-sherpa

# =============================================================================
# STAGE 2: Final - Clean image
# =============================================================================
FROM ${BASE_IMAGE}

# Copy the virtual environment with all installed packages from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy the updated stt_impl.py that includes sherpa provider
COPY stt_impl.py ./stt_impl.py

# Copy sherpa models for offline streaming speech recognition
COPY sherpa-onnx-streaming-models ./sherpa-onnx-streaming-models

# Pre-download any ML models or files the agent needs (VAD, turn detector)
RUN python main.py download-files

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app /opt/venv

# Switch to the non-privileged user for all subsequent operations
USER appuser

# After downloading, run in offline mode at runtime
ENV HF_HUB_OFFLINE=1

# Run the application
CMD ["python", "main.py", "start"]
