# syntax=docker/dockerfile:1.6
# Dockerfile for sherpa streaming STT
# Self-contained image with sherpa models for offline streaming speech recognition
# No external API calls required - all processing happens locally
#
# BUILD INSTRUCTIONS:
# This Dockerfile requires a GitHub Personal Access Token (PAT) to clone from private repos.
#
# Option 1 - Using GITHUB_TOKEN environment variable:
#   export GITHUB_TOKEN=ghp_your_token_here
#   docker build --secret id=github_token,env=GITHUB_TOKEN -f Dockerfile.sherpa -t openvidu/agent-speech-processing-sherpa:main .
#
# Option 2 - Using a token file:
#   echo "ghp_your_token_here" > ~/.github_token
#   docker build --secret id=github_token,src=$HOME/.github_token -f Dockerfile.sherpa -t openvidu/agent-speech-processing-sherpa:main .
#
# The token needs 'repo' scope for private repository access.
# Generate one at: https://github.com/settings/tokens

ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Builder - Install dependencies with GitHub token (isolated stage)
# =============================================================================
FROM ${BASE_IMAGE} AS builder

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy sherpa requirements
COPY requirements-base.txt requirements-sherpa.txt ./

# Install dependencies using GitHub token for private repo access
# The token is used here and the entire stage is thrown away - no cleanup needed
RUN --mount=type=secret,id=github_token \
    set -e; \
    if [ -f /run/secrets/github_token ]; then \
        # 1. Clean the token
        GITHUB_TOKEN="$(cat /run/secrets/github_token | tr -d '\n' | tr -d ' ')"; \
        # 2. Use a local config for this command only to keep the image clean
        git config --global credential.helper store; \
        # The 'x-access-token' username is specifically required for GitHub PATs
        echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials; \
        # 3. Perform the install
        pip install --no-cache-dir -r requirements-sherpa.txt; \
        # 4. Cleanup configuration
        rm ~/.git-credentials; \
        git config --global --unset credential.helper; \
    else \
        echo "WARNING: No github_token secret provided. Attempting install without authentication..."; \
        pip install --no-cache-dir -r requirements-sherpa.txt; \
    fi

# =============================================================================
# STAGE 2: Final - Clean image with no trace of secrets
# =============================================================================
FROM ${BASE_IMAGE}

# Copy the virtual environment with all installed packages from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy sherpa models for offline streaming speech recognition
COPY sherpa-onnx-streaming-models ./sherpa-onnx-streaming-models

# Pre-download any ML models or files the agent needs (VAD, turn detector)
RUN python main.py download-files

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app /opt/venv

# Switch to the non-privileged user for all subsequent operations
USER appuser

# After downloading, run in offline mode at runtime
ENV HF_HUB_OFFLINE=1

# Run the application
CMD ["python", "main.py", "start"]
