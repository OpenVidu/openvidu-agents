# syntax=docker/dockerfile:1.6
# Dockerfile for sherpa streaming STT with Nuitka binarization
# Self-contained image with sherpa models for offline streaming speech recognition
# Python code is compiled into a native binary for enhanced security
#
# BUILD INSTRUCTIONS:
# This Dockerfile requires a GitHub Personal Access Token (PAT) to clone from private repos.
#
# Option 1 - Using GITHUB_TOKEN environment variable:
#   export GITHUB_TOKEN=ghp_your_token_here
#   docker build --secret id=github_token,env=GITHUB_TOKEN -f Dockerfile.sherpa-binary -t openvidu/agent-speech-processing-sherpa-binary:main .
#
# Option 2 - Using a token file:
#   echo "ghp_your_token_here" > ~/.github_token
#   docker build --secret id=github_token,src=$HOME/.github_token -f Dockerfile.sherpa-binary -t openvidu/agent-speech-processing-sherpa-binary:main .
#
# The token needs 'repo' scope for private repository access.
# Generate one at: https://github.com/settings/tokens

ARG PYTHON_VERSION=3.12
ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Builder - Install dependencies with GitHub token
# =============================================================================
FROM python:${PYTHON_VERSION}-slim AS builder

# Install system dependencies needed for compilation
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    python3-dev \
    git \
    ccache \
    patchelf \
    && rm -rf /var/lib/apt/lists/*

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy requirements files
COPY requirements-base.txt requirements-sherpa.txt ./

# Install dependencies using GitHub token for private repo access
RUN --mount=type=secret,id=github_token \
    set -e; \
    if [ -f /run/secrets/github_token ]; then \
        # 1. Clean the token
        GITHUB_TOKEN="$(cat /run/secrets/github_token | tr -d '\n' | tr -d ' ')"; \
        # 2. Use a local config for this command only to keep the image clean
        git config --global credential.helper store; \
        # The 'x-access-token' username is specifically required for GitHub PATs
        echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials; \
        # 3. Perform the install (including openviduagentutils and livekit-plugins-sherpa)
        pip install --no-cache-dir -r requirements-sherpa.txt; \
        # 4. Cleanup configuration
        rm ~/.git-credentials; \
        git config --global --unset credential.helper; \
    else \
        echo "WARNING: No github_token secret provided. Attempting install without authentication..."; \
        pip install --no-cache-dir -r requirements-sherpa.txt; \
    fi

# Install Nuitka for compilation
RUN pip install --no-cache-dir nuitka==2.5.6 ordered-set zstandard

# =============================================================================
# STAGE 2: Nuitka Compilation - Compile Python code to native binary
# =============================================================================
FROM builder AS compiler

# Set working directory for compilation
WORKDIR /build

# Copy Python source files
COPY main.py stt_impl.py vad_stt_wrapper.py ./

# Create a minimal wrapper script that sets up environment before running main
# This allows us to handle environment variables and runtime configuration
RUN cat > agent_wrapper.py << 'EOF'
#!/usr/bin/env python3
"""
Wrapper script for the speech processing agent binary.
Sets up environment and runtime configuration before launching the main agent.
"""
import os
import sys

# Ensure environment is properly configured
if __name__ == "__main__":
    # Import and run the main module
    import main
    # The main module uses sys.argv, so it will handle arguments correctly
EOF

# Pre-download models and dependencies before compilation
# This ensures they are available at runtime and can be bundled if needed
ENV PATH="/opt/venv/bin:$PATH"
RUN python main.py download-files || true

# Compile the agent to a standalone binary using Nuitka
# Key options explained:
# --standalone: Create a self-contained distribution with all dependencies
# --onefile: Bundle everything into a single executable (optional, can use --standalone for dist folder)
# --follow-imports: Include all imported modules
# --include-package: Explicitly include packages that might be dynamically imported
# --include-module: Include specific modules
# --enable-plugin=anti-bloat: Remove unnecessary code
# --python-flag=no_site: Don't include site-packages at startup (we control imports)
# --python-flag=no_warnings: Suppress Python warnings in the binary
# --jobs=auto: Use all available CPU cores
# --lto=yes: Enable link-time optimization for better performance
# --output-dir=/build/dist: Output directory
# --output-filename=agent: Name of the output binary
RUN python -m nuitka \
    --standalone \
    --follow-imports \
    --include-package=livekit \
    --include-package=livekit.agents \
    --include-package=livekit.plugins \
    --include-package=livekit.rtc \
    --include-package=openviduagentutils \
    --include-package=silero \
    --include-package=asyncio \
    --include-module=stt_impl \
    --include-module=vad_stt_wrapper \
    --enable-plugin=anti-bloat \
    --python-flag=no_site \
    --python-flag=no_warnings \
    --jobs=auto \
    --lto=yes \
    --output-dir=/build/dist \
    --output-filename=agent \
    main.py

# Verify the binary was created
RUN ls -lh /build/dist/main.dist/ && \
    test -f /build/dist/main.dist/agent && \
    echo "Binary compilation successful!"

# =============================================================================
# STAGE 3: Final Runtime Image - Minimal image with only the binary
# =============================================================================
FROM python:${PYTHON_VERSION}-slim

# Install minimal runtime dependencies
# Only include libraries that the compiled binary needs to run
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Create a non-privileged user
ARG UID=10001
RUN adduser \
    --disabled-password \
    --gecos "" \
    --home "/app" \
    --shell "/sbin/nologin" \
    --uid "${UID}" \
    appuser

# Set working directory
WORKDIR /app

# Copy the compiled binary and its dependencies from the compiler stage
COPY --from=compiler /build/dist/main.dist ./agent_dist

# Copy sherpa models for offline streaming speech recognition
COPY sherpa-onnx-streaming-models ./sherpa-onnx-streaming-models

# Validate that the copied models directory contains actual model files
RUN if [ $(find sherpa-onnx-streaming-models -mindepth 1 ! -name 'README.md' | wc -l) -eq 0 ]; then \
        echo "" >&2; \
        echo "ERROR: sherpa-onnx-streaming-models directory contains no model files!" >&2; \
        echo "" >&2; \
        echo "Please run the following command before building:" >&2; \
        echo "  ./download-models.sh" >&2; \
        echo "" >&2; \
        exit 1; \
    fi

# Prepare Hugging Face cache configuration
ENV HF_HOME=/app/.cache/huggingface \
    HF_HUB_DISABLE_TELEMETRY=1 \
    HF_HUB_OFFLINE=1

# Ensure the Hugging Face cache directory exists
RUN mkdir -p "$HF_HOME"

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app

# Switch to the non-privileged user for all subsequent operations
USER appuser

# Keeps Python from buffering stdout and stderr
ENV PYTHONUNBUFFERED=1

# Run the compiled binary
# The binary name is 'agent' as specified in the Nuitka compilation step
CMD ["./agent_dist/agent", "start"]
