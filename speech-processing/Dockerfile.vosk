# syntax=docker/dockerfile:1.6
# Dockerfile for Vosk offline STT
# Self-contained image with Vosk models for offline speech recognition
# No external API calls required - all processing happens locally
#
# BUILD INSTRUCTIONS:
# This Dockerfile requires a GitHub Personal Access Token (PAT) to clone from private repos.
#
# Option 1 - Using GITHUB_TOKEN environment variable:
#   export GITHUB_TOKEN=ghp_your_token_here
#   docker build --secret id=github_token,env=GITHUB_TOKEN -f Dockerfile.vosk -t openvidu/agent-speech-processing-vosk:main .
#
# Option 2 - Using a token file:
#   echo "ghp_your_token_here" > ~/.github_token
#   docker build --secret id=github_token,src=$HOME/.github_token -f Dockerfile.vosk -t openvidu/agent-speech-processing-vosk:main .
#
# The token needs 'repo' scope for private repository access.
# Generate one at: https://github.com/settings/tokens

ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Builder - Install dependencies with GitHub token (isolated stage)
# =============================================================================
FROM ${BASE_IMAGE} AS builder

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy vosk requirements
COPY requirements-base.txt requirements-vosk.txt ./

# Install dependencies using GitHub token for private repo access
# The token is used here and the entire stage is thrown away - no cleanup needed
RUN --mount=type=secret,id=github_token \
    set -e; \
    if [ -f /run/secrets/github_token ]; then \
    GITHUB_TOKEN="$(cat /run/secrets/github_token)"; \
    git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"; \
    pip install --no-cache-dir -r requirements-vosk.txt; \
    git config --global --unset url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf; \
    else \
    echo "WARNING: No github_token secret provided. Attempting install without authentication..."; \
    pip install --no-cache-dir -r requirements-vosk.txt; \
    fi

# =============================================================================
# STAGE 2: Final - Clean image with no trace of secrets
# =============================================================================
FROM ${BASE_IMAGE}

# Copy the virtual environment with all installed packages from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy Vosk models for offline speech recognition
COPY vosk-models ./vosk-models

# Pre-download any ML models or files the agent needs (VAD, turn detector)
RUN python main.py download-files

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app /opt/venv

# Switch to the non-privileged user for all subsequent operations
USER appuser

# After downloading, run in offline mode at runtime
ENV HF_HUB_OFFLINE=1

# Run the application
CMD ["python", "main.py", "start"]
