# syntax=docker/dockerfile:1.6
# Dockerfile for Vosk offline STT
# Self-contained image with Vosk models for offline speech recognition
# No external API calls required: all processing happens locally
#
# This Dockerfile compiles libvosk.so from source to get the latest version (not available in PyPI)
#
# BUILD INSTRUCTIONS:
# This Dockerfile requires a GitHub Personal Access Token (PAT) with 'repo' scope to clone from private repos.
#
#   export GITHUB_TOKEN=ghp_your_token_here
#   docker build --secret id=github_token,env=GITHUB_TOKEN -f Dockerfile.vosk -t openvidu/agent-speech-processing-vosk:main .

ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Build Vosk/Kaldi from source
# =============================================================================
FROM debian:12-slim AS vosk-builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    git \
    cmake \
    build-essential \
    automake \
    autoconf \
    libtool \
    pkg-config \
    python3 \
    python3-dev \
    wget \
    gfortran \
    sox \
    subversion \
    zlib1g-dev \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Build Kaldi using official build process
WORKDIR /opt
RUN git clone -b vosk --single-branch --depth=1 https://github.com/alphacep/kaldi

WORKDIR /opt/kaldi/tools
RUN make openfst cub && \
    ./extras/install_openblas_clapack.sh

WORKDIR /opt/kaldi/src
RUN ./configure --mathlib=OPENBLAS_CLAPACK --shared --use-cuda=no && \
    make -j $(nproc) online2 lm rnnlm

# Build Vosk API
WORKDIR /opt
RUN git clone --depth=1 https://github.com/alphacep/vosk-api

WORKDIR /opt/vosk-api/src
RUN KALDI_ROOT=/opt/kaldi make -j $(nproc)

# =============================================================================
# STAGE 2: Python builder - Install Python dependencies with GitHub token
# =============================================================================
FROM ${BASE_IMAGE} AS builder

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy vosk requirements
COPY requirements-base.txt requirements-vosk.txt ./

# Install base requirements first
RUN pip install --no-cache-dir -r requirements-base.txt

# Install vosk Python package from PyPI (for Python code structure)
RUN pip install --no-cache-dir vosk==0.3.45

# Copy compiled libvosk.so from vosk-builder stage
COPY --from=vosk-builder /opt/vosk-api/src/libvosk.so /opt/venv/lib/python3.12/site-packages/vosk/

# Install Python bindings from GitHub to get latest __init__.py with SetEndpointerMode
RUN pip install --no-cache-dir --force-reinstall --no-deps \
    git+https://github.com/alphacep/vosk-api.git@625e44c62607a3b48fec6d72a30118448909e83f#subdirectory=python

# Restore the compiled libvosk.so (Python reinstall removed it)
COPY --from=vosk-builder /opt/vosk-api/src/libvosk.so /opt/venv/lib/python3.12/site-packages/vosk/

# Install livekit-plugins-vosk from GitHub using GitHub token for private repo access
RUN --mount=type=secret,id=github_token \
    set -e; \
    if [ -f /run/secrets/github_token ]; then \
        # 1. Clean the token
        GITHUB_TOKEN="$(cat /run/secrets/github_token | tr -d '\n' | tr -d ' ')"; \
        # 2. Use a local config for this command only to keep the image clean
        git config --global credential.helper store; \
        # The 'x-access-token' username is specifically required for GitHub PATs
        echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials; \
        # 3. Perform the install
        pip install --no-cache-dir -r requirements-vosk.txt; \
        # 4. Cleanup configuration
        rm ~/.git-credentials; \
        git config --global --unset credential.helper; \
    else \
        echo "WARNING: No github_token secret provided. Attempting install without authentication..."; \
        pip install --no-cache-dir -r requirements-vosk.txt; \
    fi

# =============================================================================
# STAGE 3: Final - Clean image with no trace of secrets
# =============================================================================
FROM ${BASE_IMAGE}

# Copy the virtual environment with all installed packages from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy vosk models for offline speech recognition
COPY vosk-models ./vosk-models

# Validate that the copied models directory contains actual model files (not just README.md)
RUN if [ $(find vosk-models -mindepth 1 ! -name 'README.md' | wc -l) -eq 0 ]; then \
        echo "" >&2; \
        echo "ERROR: vosk-models directory contains no model files!" >&2; \
        echo "" >&2; \
        echo "Please run the following command before building:" >&2; \
        echo "  ./download-models.sh" >&2; \
        echo "" >&2; \
        exit 1; \
    fi

# Pre-download any ML models or files the agent needs (VAD, turn detector)
RUN python main.py download-files

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app /opt/venv

# Switch to the non-privileged user for all subsequent operations
USER appuser

# After downloading, run in offline mode at runtime
ENV HF_HUB_OFFLINE=1

# Run the application
CMD ["python", "main.py", "start"]
