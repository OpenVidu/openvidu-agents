# syntax=docker/dockerfile:1.6
# Dockerfile for Vosk offline STT copying a pre-compiled Vosk binary (libvosk.so)
# Self-contained image with Vosk models for offline speech recognition
# No external API calls required: all processing happens locally
#
# This Dockerfile uses a pre-compiled libvosk.so binary instead of building from source.
# The binary should be placed at: vosk-models/libvosk.so

ARG BASE_IMAGE=openvidu/agent-speech-processing-base:main

# =============================================================================
# STAGE 1: Python builder - Install Python dependencies
# =============================================================================
FROM ${BASE_IMAGE} AS builder

# Create a virtual environment for clean package isolation
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy vosk requirements
COPY requirements-base.txt requirements-vosk.txt ./

# Install base requirements first
RUN pip install --no-cache-dir -r requirements-base.txt

# Install vosk Python package from PyPI (for Python code structure)
RUN pip install --no-cache-dir vosk==0.3.45

# Install Python bindings from GitHub to get latest __init__.py with SetEndpointerMode
RUN pip install --no-cache-dir --force-reinstall --no-deps \
    git+https://github.com/alphacep/vosk-api.git@625e44c62607a3b48fec6d72a30118448909e83f#subdirectory=python

# Install livekit-plugins-vosk from GitHub using GitHub token for private repo access
RUN --mount=type=secret,id=github_token \
    set -e; \
    if [ -f /run/secrets/github_token ]; then \
        # 1. Clean the token
        GITHUB_TOKEN="$(cat /run/secrets/github_token | tr -d '\n' | tr -d ' ')"; \
        # 2. Use a local config for this command only to keep the image clean
        git config --global credential.helper store; \
        # The 'x-access-token' username is specifically required for GitHub PATs
        echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials; \
        # 3. Perform the install
        pip install --no-cache-dir -r requirements-vosk.txt; \
        # 4. Cleanup configuration
        rm ~/.git-credentials; \
        git config --global --unset credential.helper; \
    else \
        echo "WARNING: No github_token secret provided. Attempting install without authentication..."; \
        pip install --no-cache-dir -r requirements-vosk.txt; \
    fi

# Copy the pre-compiled libvosk.so binary from the build context
COPY vosk-models/libvosk.so /opt/venv/lib/python3.12/site-packages/vosk/libvosk.so

# =============================================================================
# STAGE 2: Final - Clean image
# =============================================================================
FROM ${BASE_IMAGE}

# Copy the virtual environment with all installed packages from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy Vosk models for offline speech recognition
COPY vosk-models ./vosk-models

# Pre-download any ML models or files the agent needs (VAD, turn detector)
RUN python main.py download-files

# Change ownership of all app files to the non-privileged user
RUN chown -R appuser:appuser /app /opt/venv

# Switch to the non-privileged user for all subsequent operations
USER appuser

# After downloading, run in offline mode at runtime
ENV HF_HUB_OFFLINE=1

# Run the application
CMD ["python", "main.py", "start"]
